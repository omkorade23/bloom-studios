<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bloom Studios</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Great+Vibes&family=Josefin+Sans:wght@300;400&family=Cormorant+Garamond:ital,wght@0,300;1,300&display=swap"
    rel="stylesheet">
  <style>
    /* --- CSS VARIABLES & RESET --- */
    :root {
      --bg: #FFE8EA;
      --bloom: #F05858;
      --dark-red: #B82020;
      --btn-red: #B83020;
      --text-sub: #5A3030;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      width: 100%;
      min-height: 100vh;
      background: var(--bg);
      overflow-x: hidden;
      font-family: 'Josefin Sans', sans-serif;
    }

    /* --- PAGE STRUCTURE --- */
    .page {
      display: none;
      min-height: 100vh;
      width: 100%;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.4s ease;
    }

    .page.active {
      display: flex;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* --- SHARED ELEMENTS --- */
    .mini-logo-img {
      height: clamp(80px, 12vw, 140px);
      width: auto;
      object-fit: contain;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .subtitle {
      font-size: clamp(11px, 1.4vw, 14px);
      letter-spacing: 0.3em;
      color: #7A5050;
      text-transform: uppercase;
      margin-bottom: 35px;
      text-align: center;
    }

    .btn-wrap {
      background: var(--btn-red);
      color: #fff;
      border: none;
      padding: 16px 80px;
      font-family: 'Josefin Sans', sans-serif;
      font-size: 13px;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      cursor: pointer;
      transition: opacity 0.18s;
    }

    .btn-wrap:hover {
      opacity: 0.88;
    }

    /* --- PAGE 1: LANDING --- */
    #page1 {
      position: relative;
      gap: 0;
    }

    .bloom-canvas-wrap {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 60vh;
      cursor: default;
    }

    #bloomCanvas {
      display: block;
      max-width: 100%;
    }

    .btn-build {
      margin-top: 20px;
      background: var(--btn-red);
      color: #fff;
      border: none;
      padding: 16px 80px;
      font-size: 13px;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      cursor: pointer;
    }

    .byline {
      position: fixed;
      bottom: 18px;
      right: 22px;
      font-size: 11px;
      color: var(--text-sub);
      opacity: 0.6;
    }

    /* --- PAGE 2: SELECTION --- */
    #page2 {
      justify-content: flex-start;
      padding-top: 20px;
      padding-bottom: 40px;
    }

    .flower-grid {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      width: 100%;
      max-width: 1000px;
      margin-bottom: 30px;
    }

    .flower-row {
      display: flex;
      justify-content: center;
      gap: clamp(10px, 2vw, 30px);
      width: 100%;
      flex-wrap: wrap;
    }

    .flower-item {
      width: 100px;
      height: 130px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      transition: transform 0.2s;
      cursor: pointer;
      position: relative;
    }

    /* HIGHLIGHT EFFECT */
    .flower-item img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      transition: all 0.2s;
    }

    .flower-item:hover img {
      transform: scale(1.1);
    }

    /* When Selected (Visual Cue) */
    .flower-item.selected img {
      transform: scale(1.15);
      filter: drop-shadow(0 10px 15px rgba(184, 32, 32, 0.2));
    }

    .flower-item.selected::after {
      content: 'âœ“';
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--btn-red);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* --- PAGE 3: DECISION (Intermediate) --- */
    .decision-actions {
      display: flex;
      gap: 20px;
      margin-top: 10px;
      z-index: 10;
    }

    .preview-frame {
      height: clamp(250px, 55vh, 480px);
      width: 100%;
      max-width: 600px;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
    }

    .preview-frame img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 15px 25px rgba(184, 32, 32, 0.15));
    }

    /* --- PAGE 4: NOTE --- */
    .note-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      width: 100%;
      max-width: 550px;
      margin-bottom: 40px;
    }

    .recipient-input {
      width: 100%;
      padding: 15px 0;
      background: transparent;
      border: none;
      border-bottom: 1px solid rgba(184, 80, 80, 0.3);
      font-family: 'Josefin Sans', sans-serif;
      font-size: 18px;
      color: var(--dark-red);
      text-align: center;
      outline: none;
      transition: border 0.3s;
    }

    .recipient-input:focus {
      border-bottom: 1px solid var(--dark-red);
    }

    .recipient-input::placeholder {
      color: var(--text-sub);
      opacity: 0.4;
      font-style: italic;
    }

    .note-textarea {
      width: 100%;
      min-height: 180px;
      padding: 25px;
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(184, 80, 80, 0.25);
      font-family: 'Cormorant Garamond', serif;
      font-size: 22px;
      font-style: italic;
      color: #3C2020;
      resize: none;
      outline: none;
      border-radius: 4px;
    }

    .note-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      position: relative;
    }

    .btn-gen-msg {
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--dark-red);
      background: var(--bg);
      border: 1px solid rgba(184, 32, 32, 0.4);
      padding: 10px 22px;
      cursor: pointer;
      z-index: 10;
      position: relative;
    }

    .btn-gen-msg:hover {
      background: var(--dark-red);
      color: #fff;
    }

    /* Spidey */
    .spidey-wrap {
      position: relative;
      display: inline-flex;
      justify-content: center;
    }

    .spidey-img {
      position: absolute;
      left: 10px;
      top: -10px;
      width: 32px;
      height: auto;
      z-index: 1;
      opacity: 0;
      pointer-events: none;
      transition: all 1s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .spidey-wrap:hover .spidey-img {
      opacity: 1;
      top: 24px;
    }

    /* --- PAGE 5: FINAL RESULT --- */
    .result-frame-large {
      height: clamp(280px, 60vh, 550px);
      width: 100%;
      max-width: 650px;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
    }

    .result-frame-large img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 15px 25px rgba(184, 32, 32, 0.15));
    }

    /* --- UTILS --- */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 232, 234, 0.98);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .loading-overlay.show {
      display: flex;
    }

    .loading-label {
      font-family: 'Great Vibes', cursive;
      font-size: 38px;
      color: var(--dark-red);
      margin-bottom: 10px;
    }

    .loading-sub {
      font-family: 'Josefin Sans', sans-serif;
      font-size: 12px;
      color: var(--text-sub);
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: #B82020;
      color: #fff;
      padding: 10px 25px;
      border-radius: 50px;
      font-size: 12px;
      letter-spacing: 0.05em;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    .toast.show {
      opacity: 1;
    }
  </style>
</head>

<body>

  <div id="page1" class="page active">
    <div class="bloom-canvas-wrap" id="bloomWrap"><canvas id="bloomCanvas"></canvas></div>
    <button class="btn-build" onclick="showPage(2)">Build a Bouquet</button>
    <div class="byline">by Bloom Studios</div>
  </div>

  <div id="page2" class="page">
    <div onclick="showPage(1)"><img class="mini-logo-img" src='./assets/logo.png' alt="Bloom Studios" /></div>
    <div class="subtitle">Select Your Blooms (Max 10)</div>

    <div class="flower-grid">
      <div class="flower-row" id="row1"></div>
      <div class="flower-row" id="row2"></div>
    </div>

    <div class="basket-pills" id="pillContainer"></div>

    <button class="btn-wrap" id="wrapBtn" onclick="initiateWrapping()" disabled>
      Wrap Bouquet
    </button>

  </div>

  <div id="page3" class="page">
    <div onclick="showPage(1)"><img class="mini-logo-img" src='./assets/logo.png' alt="Bloom Studios" /></div>
    <div class="subtitle">Your Bouquet is Ready</div>

    <div class="preview-frame" id="baseImagePreview">
    </div>

    <div class="decision-actions">
      <button class="btn-gen-msg" onclick="goToWriteLetter()">Write a Letter</button>
      <button class="btn-gen-msg" onclick="skipToResult()">Skip & Download</button>
    </div>
  </div>

  <div id="page4" class="page">
    <div onclick="showPage(1)"><img class="mini-logo-img" src='./assets/logo.png' alt="Bloom Studios" /></div>
    <div class="subtitle">Add a Note</div>

    <div class="note-section">
      <input type="text" id="recipientInput" class="recipient-input" placeholder="Who is this for? (e.g. Mom, Sarah)">

      <textarea class="note-textarea" id="noteText" placeholder="Write something from your heart..."
        maxlength="250"></textarea>

      <div class="note-footer">
        <div class="spidey-wrap">
          <button class="btn-gen-msg" id="btnGenMsg" onclick="generateMessage()">âœ¨ Help me write it</button>
          <img src="./assets/spidey.png" class="spidey-img" alt="Spidey">
        </div>
        <div style="font-size: 11px; opacity: 0.5;"><span id="charCount">0</span>/250</div>
      </div>
    </div>

    <button class="btn-wrap" type="button" onclick="finalizeWithNote(event)">Sign & Finish</button>
  </div>

  <div id="page5" class="page">
    <div class="result-inner" style="display:flex; flex-direction:column; align-items:center;">
      <div onclick="showPage(1)"><img class="mini-logo-img" src='./assets/logo.png' alt="Bloom Studios" /></div>

      <div class="result-frame-large" id="resultFrame"></div>

      <div class="decision-actions">
        <button class="btn-wrap" onclick="downloadBouquet()">Download</button>
        <button class="btn-gen-msg" onclick="resetAndStartOver()">Make Another</button>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-label" id="loadingText">Arranging flowers...</div>
    <div class="loading-sub">Please wait a moment</div>
  </div>
  <div class="toast" id="toast"></div>

  <script>
    const API_BASE = 'https://bloom-studios.onrender.com/api';

    // 8 Pre-defined Flower Types
    const FLOWERS = [
      { id: 'sunflower', name: 'Sunflower', row: 1, src: './assets/flowers/sunflower.png' },
      { id: 'rose', name: 'Rose', row: 1, src: './assets/flowers/rose.png' },
      { id: 'tulip', name: 'Tulip', row: 1, src: './assets/flowers/tulip.png' },
      { id: 'lily', name: 'Lily', row: 1, src: './assets/flowers/lily.png' },
      { id: 'allium', name: 'Allium', row: 1, src: './assets/flowers/allium.png' },
      { id: 'aster', name: 'Aster', row: 2, src: './assets/flowers/aster.png' },
      { id: 'carnation', name: 'Carnation', row: 2, src: './assets/flowers/carnation.png' },
      { id: 'daisy', name: 'Daisy', row: 2, src: './assets/flowers/daisy.png' },
    ];

    let selectedFlowerId = null;
    let baseImageUrl = "";
    let currentFinalUrl = "";

    // --- CANVAS ANIMATION (Standard) ---
    const TULIP_FIELD_SRC = './assets/tulip-field.png';
    const canvas = document.getElementById('bloomCanvas');
    const ctx = canvas.getContext('2d');
    const bloomWrap = document.getElementById('bloomWrap');
    const REVEAL_RADIUS = 150;
    let tulipImg = null, logoImg = null;
    let cursorX = -999, cursorY = -999, rafPending = false;
    let tempCanvas = document.createElement('canvas');
    let tempCtx = tempCanvas.getContext('2d');

    const _tImg = new Image(); _tImg.src = TULIP_FIELD_SRC;
    _tImg.onload = () => { tulipImg = _tImg; scheduleFrame(); };
    const _lImg = new Image(); _lImg.src = './assets/logo.png';
    _lImg.onload = () => { logoImg = _lImg; initCanvas(); };

    function initCanvas() {
      if (!logoImg) return;
      const dpr = window.devicePixelRatio || 1;
      const W = window.innerWidth, H = window.innerHeight * 0.6;
      canvas.width = W * dpr; canvas.height = H * dpr;
      canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
      tempCanvas.width = W * dpr; tempCanvas.height = H * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0); tempCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
      scheduleFrame();
    }
    function drawFrame() {
      rafPending = false;
      const W = canvas.width / (window.devicePixelRatio || 1);
      const H = canvas.height / (window.devicePixelRatio || 1);
      ctx.clearRect(0, 0, W, H);
      if (!logoImg) return;
      const scale = Math.min((W - 20) / logoImg.width, (H - 20) / logoImg.height, 1.2);
      const dW = logoImg.width * scale, dH = logoImg.height * scale;
      const dX = (W - dW) / 2, dY = (H - dH) / 2;
      ctx.drawImage(logoImg, dX, dY, dW, dH);
      if (tulipImg) {
        tempCtx.clearRect(0, 0, W, H);
        const grad = tempCtx.createRadialGradient(cursorX, cursorY, 0, cursorX, cursorY, REVEAL_RADIUS);
        grad.addColorStop(0, 'rgba(255,255,255,1)'); grad.addColorStop(1, 'rgba(255,255,255,0)');
        tempCtx.fillStyle = grad; tempCtx.fillRect(0, 0, W, H);
        tempCtx.globalCompositeOperation = 'source-in';
        const tScale = Math.max(dW / tulipImg.width, dH / tulipImg.height);
        tempCtx.drawImage(tulipImg, dX + (dW - tulipImg.width * tScale) / 2, dY + (dH - tulipImg.height * tScale) / 2, tulipImg.width * tScale, tulipImg.height * tScale);
        tempCtx.globalCompositeOperation = 'source-over';
        ctx.save(); ctx.globalCompositeOperation = 'source-atop';
        ctx.drawImage(tempCanvas, 0, 0, W, H); ctx.restore();
      }
    }
    function scheduleFrame() { if (!rafPending) { rafPending = true; requestAnimationFrame(drawFrame); } }
    bloomWrap.addEventListener('mousemove', e => { const r = canvas.getBoundingClientRect(); cursorX = e.clientX - r.left; cursorY = e.clientY - r.top; scheduleFrame(); });
    window.addEventListener('resize', initCanvas);


    // --- SELECTION LOGIC (No Pills) ---
    function buildGrid() {
      document.getElementById('row1').innerHTML = '';
      document.getElementById('row2').innerHTML = '';

      FLOWERS.forEach(f => {
        const el = document.createElement('div');
        el.className = 'flower-item';
        el.id = `item-${f.id}`;
        el.innerHTML = `<img src="${f.src}" onerror="this.style.display='none'">`;
        // Toggle selection on click
        el.onclick = () => selectFlower(f.id);

        document.getElementById(f.row === 1 ? 'row1' : 'row2').appendChild(el);
      });
    }
    buildGrid();

    function selectFlower(id) {
      // Toggle Logic: If clicked same flower, deselect it.
      if (selectedFlowerId === id) {
        selectedFlowerId = null;
      } else {
        selectedFlowerId = id;
      }
      updateUI();
    }

    function updateUI() {
      // 1. Update Grid Highlights (The only visual indicator now)
      FLOWERS.forEach(f => {
        const el = document.getElementById(`item-${f.id}`);
        if (f.id === selectedFlowerId) el.classList.add('selected');
        else el.classList.remove('selected');
      });

      // 2. Enable/Disable Wrap Button
      const wrapBtn = document.getElementById('wrapBtn');
      if (selectedFlowerId) {
        wrapBtn.disabled = false;
        wrapBtn.style.opacity = "1";
        wrapBtn.style.cursor = "pointer";
      } else {
        wrapBtn.disabled = true;
        wrapBtn.style.opacity = "0.5";
        wrapBtn.style.cursor = "not-allowed";
      }
    }

    // --- WRAPPING LOGIC ---
    async function initiateWrapping(event) {
      if (event) event.preventDefault();

      // Double check selection
      if (!selectedFlowerId) {
        showToast("Please select a flower ðŸŒ¸");
        return;
      }

      const loading = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');
      loading.classList.add('show');
      loadingText.innerText = "Retrieving your bouquet...";

      try {
        // Ask for the bouquet of the selected flower
        const res = await fetch(`${API_BASE}/generate-bouquet`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          // Backend expects "flower_id" now
          body: JSON.stringify({ flower_id: selectedFlowerId })
        });

        if (!res.ok) throw new Error("Could not retrieve bouquet.");
        const data = await res.json();

        // Construct URL
        baseImageUrl = "https://bloom-studios.onrender.com" + data.image_url;

        // Preload Image
        const img = new Image();
        img.onload = function () {
          const previewEl = document.getElementById('baseImagePreview');
          previewEl.innerHTML = '';
          previewEl.appendChild(img);
          loading.classList.remove('show');
          showPage(3);
        };
        img.onerror = function () {
          alert("Image failed to load.");
          loading.classList.remove('show');
        };
        // Cache bust
        img.src = `${baseImageUrl}?t=${Date.now()}`;

      } catch (err) {
        alert("Error: " + err.message);
        loading.classList.remove('show');
      }
    }

    // --- NAVIGATION & UTILS ---
    function goToWriteLetter() { showPage(4); }
    function skipToResult() { currentFinalUrl = baseImageUrl; showResult(); }

    async function generateMessage() {
      const recipient = document.getElementById('recipientInput').value.trim();
      const name = recipient ? recipient : "Someone Special";
      const btn = document.getElementById('btnGenMsg');
      btn.innerText = "Gemini is writing...";
      btn.disabled = true;

      try {
        const res = await fetch(`${API_BASE}/generate-message`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ recipient: name, flower_id: selectedFlowerId })
        });
        const data = await res.json();
        document.getElementById('noteText').value = data.message;
      } catch (err) {
        document.getElementById('noteText').value = `To ${name}, hope you like these blooms!`;
      } finally {
        btn.innerText = "âœ¨ Help me write it";
        btn.disabled = false;
      }
    }

    async function finalizeWithNote(event) {
      // 1. This stops the page from reloading/freezing!
      if (event) event.preventDefault();

      const note = document.getElementById('noteText').value;
      if (!note.trim()) {
        skipToResult();
        return;
      }

      const loading = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');
      loading.classList.add('show');
      loadingText.innerText = "Signing your card...";

      try {
        // Remove the local host part so it works dynamically
        const relativePath = baseImageUrl.replace("https://bloom-studios.onrender.com", "");

        const res = await fetch(`${API_BASE}/add-note`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image_url: relativePath, message_text: note })
        });

        if (!res.ok) throw new Error("Backend failed to create card.");

        const data = await res.json();
        currentFinalUrl = "https://bloom-studios.onrender.com" + data.final_image_url;
        showResult();

      } catch (err) {
        alert("Note failed: " + err.message);
        currentFinalUrl = baseImageUrl;
        showResult();
      } finally {
        loading.classList.remove('show');
      }
    }

    function showResult() {
      const frame = document.getElementById('resultFrame');
      frame.innerHTML = `<img src="${currentFinalUrl}?t=${Date.now()}" onerror="this.src='./assets/logo.png'">`;
      showPage(5);
    }

    function showPage(n) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      const target = document.getElementById('page' + n);
      if (target) target.classList.add('active');
    }

    function resetAndStartOver() {
      selectedFlowerId = null;
      document.getElementById('noteText').value = "";
      document.getElementById('recipientInput').value = "";
      buildGrid();
      updateUI();
      showPage(2);
    }

    function showToast(msg) {
      const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }
    function downloadBouquet() {
      const a = document.createElement('a'); a.href = currentFinalUrl; a.download = 'bloom.png'; a.click();
    }
  </script>
</body>

</html>